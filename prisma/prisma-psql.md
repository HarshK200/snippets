# Prisma problems that i commonly tackle with solutions

## 1. Quick notes on setting up prisma with postgresql in nextjs (using app dir)

**Alright first startup a quick postgres server locally to connect to and development (docker command
in the snippets/docker-cmds.md file)**

After you got your local development db running put its **connection-string in a .env file** we'll
need it later.

for now we need to install two prisma packages:

first, is **primsa** the CLI that we will use to migrate, seed, etc... our database (since this is a
cli and is only needed during development our CI/CD pipeline we can install it as a dev dependency)

```
npm install primsa --save-dev
```

second, is **@primsa/client** this is the actual code the ORM that does all the heavy lifting so we
don't have to write boring ass SQL since this is code that actually runs per request it needs to be
our main dependency i.e NO!!! Save dev here.

```
npm install @prisma/client
```

**Alright now that we have installed prisma we need to initialize it and there a simple command for
exaclty that i.e.**

```
npx prisma init
```

NOTE: for quick setup you can also give a datasource-provider flag like
`npx prisma init --datasource-provider postgres`

**The init command will create a primsa/ folder in the root of your project with a prisma.schema file
that looks like:**

```typescript
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
```

`NOTE: Make sure your .env varible is the same as in prisma`

Alright you are pretty much done here now just make a model an example would be:

```typescript
model User {
    id        String @id @default(uuid())
    email     String @unique
    password  String
    firstName String
    lastName  String
}
```

**Now that we have created our model we just need to migrate i.e. create tables in our database** and
we got a simple command for that:

```
npx prisma migrate dev --name init
```

**NOTE: `npx prisma migrate dev` and `npx prisma migrate reset` are dev commands and should only be
used in development environment and not in production for production you should use:
`npx prisma migrate deploy`**

### Additional tips (when building/deploying)

#### Build process prisma type definitions generation

The type definition are generated by prisma in the node_modules folder but since its not commited
to the github repo we need to regenerate the type defintions and the command for that is:
`npx prisma generate`, **so let's just add this to our build script in package.json**

```json
"scripts": {
  "dev": "next dev",
  "build": "prisma generate && next build", // <------ just add the command here
  "start": "next start",
  "lint": "next lint"
}
```

<br>

#### Seeding the database in primsa(nextjs)

for reference here's the offical docs: <a>https://www.prisma.io/docs/orm/prisma-migrate/workflows/seeding</a>

Alright to seed the database we gotta do a few things **first we install a dev-dependency i.e.**

```
npm install ts-node --save-dev
```

**what this does is that it can run execute typescript files which is exactly what we need because
we will be creating a /prisma/seed.ts file NOTE:(this file is ran after migration and update to db
is done)**, this file is specified to prisma by putting it as a key-value pair in the package.json
like so:

```json
{
  "name": "jae-commerce",
  "version": "0.1.0",
  "private": true,
  "prisma": {
    "seed": "ts-node prisma/seed.ts" // <--------------------- like so here
  }
  "scripts": {
    "dev": "next dev",
    "build": "prisma generate && next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@prisma/client": "^6.3.0",
    "@reduxjs/toolkit": "^2.5.0",
    "lucide-react": "^0.474.0",
    "next": "15.1.6",
    "next-auth": "^4.24.11",
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "react-redux": "^9.2.0"
  },
  "devDependencies": {
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "postcss": "^8",
    "prisma": "^6.3.0",
    "tailwindcss": "^3.4.1",
    "typescript": "^5"
  }
}
```

`NOTE: obviously you do need to make a seed.ts file in the /prisma directory as well, duh!`

Example for seed.ts file: (also look at <a>https://github.com/code100x/cms/blob/main/prisma/seed.ts
</a> thanks surgum again :>)

```typescript
// NOTE: either do this
// const db = new PrismaClient();
// import { PrismaClient } from "@prisma/client";
//              OR

import db from "../src/db"; // NOTE: you cannot use the tsconfig type alias here i.e. @/db

async function seedUsers() {
  const dummyUsers = [
    {
      id: "1",
      email: "testuser1@example.com",
      password: "some$ecure_password1",
      firstName: "Test",
      lastName: "User",
    },
  ];

  try {
    dummyUsers.forEach(async (user) => {
      await db.user.upsert({
        where: {
          id: user.id,
        },
        update: {},
        create: {
          email: user.email,
          password: user.password,
          firstName: user.firstName,
          lastName: user.lastName,
        },
      });
    });
  } catch (err) {
    console.error("Err seeding users");
    throw err;
  }
}

async function seedDB() {
  try {
    await seedUsers();
  } catch (err) {
    console.error("Error seeding database:", err);
    throw err;
  } finally {
    db.$disconnect();
  }
}

seedDB().catch((err) => {
  console.error("An unexpected error occured during seeding: ", err);
  process.exit(1);
});
```

Alright now we have everything setup let her rip, use the command:

```
npx prisma db seed
```

Alright everything should be set now connect to your db and you are check if the changes reflected :>

<br>

## 2. Basic prisma.schema (with one user model)

Note: (the prisma.schema file and the primsa/ directory both are generated with the `primsa init`
command)

```typescript
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// MODELS
model User {
    id        String @id @default(uuid())
    email     String @unique
    password  String
    firstname String
    lastname  String
}
```

<br>

## 3. Basic CRUD (these are Nextjs examples but prisma codes same for react)

#### Create:

```typescript
import { PrismaClient } from "@prisma/client";
const db = new PrismaClient();

export async function POST(req: NextRequest) {
  const { firstname, lastname, email, password } = await req.json();
  const hashedPassword = await hash(password, 10);

  // Make sure you do your validation using zod or something else!!!

  const user = await db.user.create({
    data: {
      firstname: firstname,
      lastname: lastname,
      email: email,
      password: hashedPassword,
    },
  });

  return NextResponse.json({
    message: "dragon dezznuts /api/register",
  });
}
```
